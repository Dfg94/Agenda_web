<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#8b5a2b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Panel Admin</title>
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" href="/static/icon-192.png" type="image/png">
    <link rel="stylesheet" href="/static/style.css?v=9">
    <style>
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            color: #888;
            border-bottom: 3px solid transparent;
        }

        .tab.activa {
            color: #8b5a2b;
            border-bottom-color: #8b5a2b;
        }

        .tab-content {
            display: none;
        }

        .tab-content.activa {
            display: block;
        }

        .cliente-item {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            background: #fafafa;
            transition: 0.2s;
        }

        .cliente-item:hover {
            background: #fff0f5;
        }

        .cliente-detalles {
            display: none;
            padding: 15px;
            background: #fff;
            border: 1px solid #8b5a2b;
            border-radius: 8px;
            margin-top: 10px;
        }

        /* Modal para modificar citas */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 400px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .modal-content h3 {
            margin-top: 0;
            color: #8b5a2b;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div class="card">

        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>Panel Admin</h1>
            <a href="/logout"
                style="color: #6d4c41; text-decoration: none; font-weight: bold; font-size: 0.9em; padding: 5px 10px; border: 1px solid #6d4c41; border-radius: 8px;">Cerrar
                sesiÃ³n</a>
        </div>

        <div class="tabs">
            <div class="tab activa" onclick="switchTab('citas', this)">ðŸ“… Citas y Calendario</div>
            <div class="tab" onclick="switchTab('clientes', this)">ðŸ‘¥ Clientes Registrados</div>
        </div>

        <!-- PestaÃ±a de Citas (Todo el panel actual) -->
        <div id="tab-citas" class="tab-content activa">
            <div class="grid">

                <div class="box">
                    <h3>Nueva cita</h3>
                    <input type="date" id="fecha">
                    <input id="cliente" placeholder="Cliente">
                    <input id="hora" placeholder="Hora">

                    <select id="servicio">
                        {% for s,d in servicios.items() %}
                        <option value="{{s}}">{{s}} ({{d}} min)</option>
                        {% endfor %}
                    </select>

                    <button onclick="crear()">Crear cita</button>
                </div>


                <div class="box">
                    <h3>Horarios manuales</h3>
                    <input type="date" id="fechaExtra">
                    <input id="horaExtra" placeholder="Hora">
                    <button onclick="addExtra()">Agregar</button>

                    {% for e in extras %}
                    <div class="mini">
                        {{e.fecha | formato_fecha}} â€” {{e.hora}}
                        <button onclick="delExtra({{loop.index0}})">X</button>
                    </div>
                    {% endfor %}
                </div>


                <div class="box">
                    <h3>Bloquear horario</h3>
                    <input type="date" id="fechaBloq">
                    <input id="horaBloq" placeholder="Hora">
                    <button onclick="bloquear()">Bloquear</button>

                    {% for b in bloqueados %}
                    <div class="mini">
                        {{b.fecha | formato_fecha}} â€” {{b.hora}}
                        <button onclick="desbloquear({{loop.index0}})">Quitar</button>
                    </div>
                    {% endfor %}
                </div>


                <div class="box">
                    <h3>Bloquear dÃ­a</h3>
                    <input type="date" id="diaBloq">
                    <button onclick="bloquearDia()">Bloquear</button>

                    {% for d in dias_bloqueados %}
                    <div class="mini">
                        {{d | formato_fecha}}
                        <button onclick="desbloquearDia({{loop.index0}})">Quitar</button>
                    </div>
                    {% endfor %}
                </div>


                <div class="box full">
                    <h3>Citas guardadas</h3>

                    <!-- Calendario admin -->
                    <div class="calendar" style="margin-top:14px;">
                        <div class="cal-header">
                            <button onclick="adminMes(-1)" type="button">â€¹</button>
                            <span id="adminMesTitulo"></span>
                            <button onclick="adminMes(1)" type="button">â€º</button>
                        </div>
                        <div class="semana">
                            <div>Lun</div>
                            <div>Mar</div>
                            <div>MiÃ©</div>
                            <div>Jue</div>
                            <div>Vie</div>
                            <div>SÃ¡b</div>
                            <div>Dom</div>
                        </div>
                        <div class="dias" id="adminDias"></div>
                    </div>

                    <!-- Lista filtrada por dÃ­a -->
                    <div id="adminLista" style="margin-top:10px;">
                        <p style="text-align:center;opacity:0.45;font-size:0.9em;padding:10px 0;">
                            Selecciona un dÃ­a para ver las citas
                        </p>
                    </div>
                </div>

            </div>
        </div>

        <!-- PestaÃ±a de Clientes -->
        <div id="tab-clientes" class="tab-content">
            <h3 style="margin-bottom: 15px;">Listado de Clientes</h3>

            <input type="text" id="buscador-clientes" placeholder="Buscar por nombre o correo..."
                onkeyup="filtrarClientes()" style="margin-bottom: 20px;">

            <div id="lista-clientes-container">
                {% if usuarios %}
                {% for u in usuarios %}
                <div class="cliente-item" onclick="toggleClienteDetalles('{{ u.email }}')">
                    <strong>{{ u.nombre }}</strong>
                    <div id="detalles-{{ u.email }}" class="cliente-detalles">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                            <img src="{{ u.foto if u.foto else 'https://ui-avatars.com/api/?name=' + u.nombre + '&background=8b5a2b&color=fff' }}"
                                alt="Foto de perfil de {{ u.nombre }}"
                                style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid #8b5a2b;">
                            <div>
                                <p style="margin: 0;">ðŸ“§ Email: {{ u.email }}</p>
                                <p style="margin: 5px 0 0 0;">ðŸ“ž TelÃ©fono: {{ u.telefono if u.telefono else 'No
                                    registrado'
                                    }}</p>
                            </div>
                        </div>
                        <h4 style="margin-top:10px;">AÃ±adir Nueva Cita</h4>
                        <div
                            style="background:#f9f9f9; padding:10px; border-radius:8px; margin-bottom:15px; border:1px solid #ddd;">
                            <input type="date" id="nueva-fecha-{{loop.index}}" style="margin-top:0;">
                            <input type="time" id="nueva-hora-{{loop.index}}">
                            <select id="nuevo-servicio-{{loop.index}}">
                                {% for s,d in servicios.items() %}
                                <option value="{{s}}">{{s}} ({{d}} min)</option>
                                {% endfor %}
                            </select>
                            <button onclick="crearCitaInline('{{ u.email }}', '{{ u.nombre }}', {{loop.index}})"
                                style="padding:8px; font-size:0.9em;">Confirmar Cita</button>
                        </div>

                        <hr style="border: 0; border-top: 1px solid #eee; margin: 10px 0;">
                        <h4>PrÃ³ximas Citas</h4>
                        <div id="futuras-{{ u.email }}"></div>
                        <h4 style="margin-top:10px;">Historial</h4>
                        <div id="pasadas-{{ u.email }}"></div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p>No hay clientes registrados aÃºn.</p>
                {% endif %}
            </div>
        </div>

    </div>

    <!-- Modal Modificar Cita -->
    <div id="modal-modificar" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalModificar()">&times;</span>
            <h3>Modificar Cita</h3>
            <input type="hidden" id="mod-index">

            <label>Nueva Fecha:</label>
            <input type="date" id="mod-fecha">

            <label>Nueva Hora:</label>
            <input type="time" id="mod-hora">

            <label>Servicio:</label>
            <select id="mod-servicio">
                {% for s,d in servicios.items() %}
                <option value="{{s}}">{{s}} ({{d}} min)</option>
                {% endfor %}
            </select>

            <button onclick="guardarModificacion()" style="margin-top: 15px;">Guardar Cambios</button>
        </div>
    </div>


    <script>

        function crear() {
            fetch("/crear", {
                method: "POST", headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    fecha: fecha.value,
                    cliente: cliente.value,
                    hora: hora.value,
                    servicio: servicio.value
                })
            }).then(() => location.reload())
        }

        function borrar(i) {
            fetch("/eliminar", {
                method: "POST", headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ index: i })
            }).then(() => location.reload())
        }

        function addExtra() {
            fetch("/agregar_extra", {
                method: "POST", headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ fecha: fechaExtra.value, hora: horaExtra.value })
            }).then(() => location.reload())
        }

        function delExtra(i) {
            fetch("/borrar_extra", {
                method: "POST", headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ index: i })
            }).then(() => location.reload())
        }

        function bloquear() {
            fetch("/bloquear", {
                method: "POST", headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ fecha: fechaBloq.value, hora: horaBloq.value })
            }).then(() => location.reload())
        }

        function desbloquear(i) {
            fetch("/desbloquear", {
                method: "POST", headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ index: i })
            }).then(() => location.reload())
        }

        function bloquearDia() {
            fetch("/bloquear_dia", {
                method: "POST", headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ fecha: diaBloq.value })
            }).then(() => location.reload())
        }

        function desbloquearDia(i) {
            fetch("/desbloquear_dia", {
                method: "POST", headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ index: i })
            }).then(() => location.reload())
        }

        // â”€â”€â”€ Calendario de citas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const todasReservas = {{ reservas | tojson }};

        let adminFecha = new Date();
        let adminFechaSel = null;

        const mesesNombre = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
            "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        function adminRenderCalendar() {
            const aÃ±o = adminFecha.getFullYear();
            const mes = adminFecha.getMonth();
            adminMesTitulo.innerText = mesesNombre[mes] + " " + aÃ±o;

            let primerDia = new Date(aÃ±o, mes, 1).getDay();
            if (primerDia === 0) primerDia = 7;
            const diasMes = new Date(aÃ±o, mes + 1, 0).getDate();

            // Fechas con citas en este mes
            const conCitas = new Set(
                todasReservas
                    .filter(r => r.fecha.startsWith(aÃ±o + "-" + String(mes + 1).padStart(2, "0")))
                    .map(r => r.fecha)
            );

            let html = "";
            let fHoy = new Date();
            let hoyStr = fHoy.getFullYear() + "-" + String(fHoy.getMonth() + 1).padStart(2, "0") + "-" + String(fHoy.getDate()).padStart(2, "0");

            for (let i = 1; i < primerDia; i++) html += "<div></div>";
            for (let d = 1; d <= diasMes; d++) {
                const f = aÃ±o + "-" + String(mes + 1).padStart(2, "0") + "-" + String(d).padStart(2, "0");
                const tieneC = conCitas.has(f);
                const esActiva = f === adminFechaSel ? " activa" : "";
                const esHoy = f === hoyStr ? " hoy" : "";
                html += `<div class="dia${esActiva}${esHoy}${tieneC ? " con-cita" : ""}" onclick="adminSeleccionar('${f}',this)">${d}${tieneC ? '<span class="punto"></span>' : ""}</div>`;
            }
            adminDias.innerHTML = html;
        }

        function adminMes(n) {
            adminFecha.setMonth(adminFecha.getMonth() + n);
            adminRenderCalendar();
        }

        function adminSeleccionar(f, el) {
            document.querySelectorAll("#adminDias .dia").forEach(x => x.classList.remove("activa"));
            el.classList.add("activa");
            adminFechaSel = f;
            adminMostrarCitas(f);
        }

        function adminMostrarCitas(fecha) {
            const citas = todasReservas.filter(r => r.fecha === fecha);

            const partes = fecha.split('-');
            const fechaFormateada = partes.length === 3 ? partes[2] + '/' + partes[1] + '/' + partes[0] : fecha;

            if (citas.length === 0) {
                adminLista.innerHTML = `<p style="text-align:center;opacity:0.45;font-size:0.9em;padding:10px 0;">Sin citas el ${fechaFormateada}</p>`;
                return;
            }
            adminLista.innerHTML = citas.map(r => {
                const idx = todasReservas.indexOf(r);
                const telHtml = r.telefono ? `<br><small style="color:#666;">ðŸ“ž ${r.telefono}</small>` : "";
                const notaHtml = r.nota ? `<br><small style="color:#8b5a2b; display:block; margin-top:4px;"><em>Nota:</em> ${r.nota}</small>` : "";
                return `<div class="mini">
                    <strong>${r.inicio}</strong> â€” ${r.cliente} â€” ${r.servicio} ${telHtml} ${notaHtml}
                    <button onclick="borrar(${idx})" style="margin-top:6px;">Eliminar</button>
                </div>`;
            }).join("");
        }

        adminRenderCalendar();

        // â”€â”€â”€ LÃ³gica de PestaÃ±as y Clientes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function switchTab(tabId, el) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('activa'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('activa'));

            el.classList.add('activa');
            document.getElementById('tab-' + tabId).classList.add('activa');
        }

        function toggleClienteDetalles(email) {
            const detalles = document.getElementById('detalles-' + email);

            // Si ya estÃ¡ abierto, lo cerramos
            if (detalles.style.display === 'block') {
                detalles.style.display = 'none';
                return;
            }

            // Cerrar todos los demÃ¡s primero
            document.querySelectorAll('.cliente-detalles').forEach(d => d.style.display = 'none');

            // Filtrar citas de este usuario
            const citasUsuario = todasReservas.filter(r => r.email === email);

            const hoy = new Date();
            const futuras = [];
            const pasadas = [];

            citasUsuario.forEach(r => {
                const fechaHora = new Date(r.fecha + "T" + r.inicio);
                if (fechaHora >= hoy) {
                    futuras.push(r);
                } else {
                    pasadas.push(r);
                }
            });

            // FunciÃ³n helper para renderizar citas en los bloques
            const renderCitaInfo = (citaArr, esFutura) => {
                if (citaArr.length === 0) return "<p style='color:#888; font-size:13px;'>Ninguna</p>";
                return citaArr.map(r => {
                    const partes = r.fecha.split('-');
                    const fechaF = partes.length === 3 ? partes[2] + '/' + partes[1] + '/' + partes[0] : r.fecha;
                    const idxGlobal = todasReservas.indexOf(r);

                    let botones = "";
                    if (esFutura) {
                        botones = `<div style="margin-top: 8px;">
                            <button onclick="borrar(${idxGlobal})" style="background:#d9534f; padding:5px 10px; font-size:12px; width:auto; border-radius:8px;">Cancelar</button>
                        </div>`;
                    }

                    return `<div style="background:#f5f5f5; padding:8px; border-radius:6px; margin-bottom:5px; font-size:14px;">
                        <strong>${fechaF} ${r.inicio}</strong> - ${r.servicio}
                        ${botones}
                    </div>`;
                }).join('');
            };

            // Ordenar futuras (mÃ¡s cercanas primero)
            futuras.sort((a, b) => new Date(a.fecha + "T" + a.inicio) - new Date(b.fecha + "T" + b.inicio));
            // Ordenar pasadas (mÃ¡s recientes primero)
            pasadas.sort((a, b) => new Date(b.fecha + "T" + b.inicio) - new Date(a.fecha + "T" + a.inicio));

            document.getElementById('futuras-' + email).innerHTML = renderCitaInfo(futuras, true);
            document.getElementById('pasadas-' + email).innerHTML = renderCitaInfo(pasadas, false);

            detalles.style.display = 'block';
        }

        function filtrarClientes() {
            const input = document.getElementById("buscador-clientes");
            const filter = input.value.toLowerCase();
            const container = document.getElementById("lista-clientes-container");
            const items = container.getElementsByClassName("cliente-item");

            for (let i = 0; i < items.length; i++) {
                const nombre = items[i].getElementsByTagName("strong")[0].innerText.toLowerCase();
                const texto = items[i].innerText.toLowerCase();

                if (nombre.includes(filter) || texto.includes(filter)) {
                    items[i].style.display = "";
                } else {
                    items[i].style.display = "none";
                }
            }
        }

        function crearCitaInline(emailDestino, nombreCliente, indexForm) {
            const fechaInput = document.getElementById(`nueva-fecha-${indexForm}`).value;
            const horaInput = document.getElementById(`nueva-hora-${indexForm}`).value;
            const servicioInput = document.getElementById(`nuevo-servicio-${indexForm}`).value;

            if (!fechaInput || !horaInput) {
                alert("Por favor selecciona fecha y hora.");
                return;
            }

            fetch("/crear", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    fecha: fechaInput,
                    cliente: nombreCliente,
                    email: emailDestino,
                    hora: horaInput,
                    servicio: servicioInput,
                    nota: "Reserva administrativa"
                })
            }).then(() => location.reload());
        }

        // --- LÃ³gica Modal ModificaciÃ³n ---
        function abrirModalModificar(index, fecha, hora, servicio) {
            document.getElementById('mod-index').value = index;
            document.getElementById('mod-fecha').value = fecha;
            document.getElementById('mod-hora').value = hora;
            document.getElementById('mod-servicio').value = servicio;
            document.getElementById('modal-modificar').style.display = 'block';
        }

        function cerrarModalModificar() {
            document.getElementById('modal-modificar').style.display = 'none';
        }

        function guardarModificacion() {
            const index = document.getElementById('mod-index').value;
            const fecha = document.getElementById('mod-fecha').value;
            const hora = document.getElementById('mod-hora').value;
            const servicio = document.getElementById('mod-servicio').value;

            if (!fecha || !hora) {
                alert("Fecha y hora son obligatorios");
                return;
            }

            fetch("/modificar", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ index, fecha, hora, servicio })
            }).then(() => location.reload());
        }

    </script>

</body>

</html>